<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
                           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.2.xsd">

  <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="location" value="classpath:site.properties" />
  </bean>

  <!-- 全 URL　に対して Filter をかける場合の　URL マッピングリスト -->
  <util:list id="fullUrlPattern" list-class="java.util.ArrayList">
    <value>/###allPages###/</value>
    <value>/###allPages###/###allPages###/</value>
    <value>/###allPages###/###allPages###/###allPages###/</value>
    <value>/###allPages###/###allPages###/###allPages###/###allPages###/</value>
    <value>/###allPages###/###allPages###/###allPages###/###allPages###/###allPages###/</value>
    <value>/###allPages###/###allPages###/###allPages###/###allPages###/###allPages###/###allPages###/</value>
    <value>/###allPages###/###allPages###/###allPages###/###allPages###/###allPages###/###allPages###/###allPages###/</value>
  </util:list>

<!--
	フィルターの設定はここに記載すること。
	記述された順番にフィルターが動きます。
 -->

  <!-- リクエストスコープへロードする共通処理 -->
  <bean id="requestScopeBeanLoader" class="jp.co.transcosmos.dm3.utils.AddBeanToRequestScopeCommand">
    <property name="beanMap">
      <map>
        <entry key="codeLookupManager" value-ref="codeLookupManager"/>
        <entry key="commonParameters" value-ref="commonParameters"/>
      </map>
    </property>
  </bean>

  <!-- 認証処理（ログイン済かのチェック）を行うフィルター処理 -->
  <bean id="loginCheckFilter" class="jp.co.transcosmos.dm3.login.command.v3.LoginCheckFilter">
    <property name="authentication" ref="authentication" />
    <property name="addNoCacheHeaders" value="false" />
  </bean>

  <!-- パスワード有効期限のチェックを行うフィルター処理 -->
  <bean id="passwordExpireFilter" class="jp.co.transcosmos.dm3.login.command.v3.PasswordExpireFilter">
    <property name="authentication" ref="authentication" />
    <property name="passwordExpireDays" value="${site.passwordChangeExpire}" />
  </bean>

  <!-- 管理者権限のチェックを行うフィルター処理 -->
  <bean id="adminRoleCheckFilter" class="jp.co.transcosmos.dm3.login.command.v3.HasRoleCheckFilter">
    <property name="authentication" ref="authentication" />
    <property name="roles" value="admin" />
  </bean>

  <!-- メニュー情報を設定するフィルター処理 -->
  <bean id="addMenuFilter" class="jp.co.transcosmos.dm3.adminCore.menu.AddMenuCommand">
    <property name="menuInfo" ref="menuInfo" />
    <property name="defaultRoles" value ="admin,user" />
  </bean>

	<!-- CSRF トークンチェックフィルター処理 -->
	<bean id="tokenCheckFilter" class="jp.co.transcosmos.dm3.token.TokenCheckFilter">
		<property name="redirectUrl" value="/error/token/" />
	</bean>
  
  <bean class="jp.co.transcosmos.dm3.servlet.URLCommandViewMappingList">
    <property name="commandURLMapper" ref="commandURLMapper"/>
    <property name="mappings">
      <list>

        <!-- リクエストスコープへ共通処理をロード -->
        <bean class="jp.co.transcosmos.dm3.servlet.URLCommandViewMapping">
          <property name="urlPattern" ref="fullUrlPattern" />
          <property name="defaultCommandName" value="requestScopeBeanLoader"/>
          <property name="filter" value="true"/>
        </bean>

        <!-- 認証処理 -->
        <bean class="jp.co.transcosmos.dm3.servlet.URLCommandViewMapping">
          <property name="urlPattern" ref="fullUrlPattern" />
          <property name="exceptionUrlPattern">
            <list>
              <value>/login/</value>
              <value>/login/check/</value>
              <value>/login/logout/</value>
              <value>/error/</value>
              <value>/error/###allPages###/</value>
              <value>/health_chk/</value>
            </list>
          </property>
          <property name="defaultCommandName" value="loginCheckFilter"/>
          <property name="filter" value="true"/>
          <property name="namedViews">
            <props>
              <prop key="failure">redirect:###!webroot###/login/</prop>
            </props>
          </property>
        </bean>

        <!--
        	パスワード有効期限チェック処理 （Panasonic 用に URL を変更）
        	もし、パスワード有効期限のチェックが不要な場合、このフィルターをコメントアウトする。
       	-->
        <bean class="jp.co.transcosmos.dm3.servlet.URLCommandViewMapping">
          <property name="urlPattern" ref="fullUrlPattern" />
          <property name="exceptionUrlPattern">
            <list>
              <value>/login/</value>
              <value>/login/check/</value>
              <value>/login/logout/</value>
              <value>/error/</value>
              <value>/error/###allPages###/</value>
              <value>/top/password/###allPages###/</value>
              <value>/health_chk/</value>
            </list>
          </property>
          <property name="defaultCommandName" value="passwordExpireFilter"/>
          <property name="filter" value="true"/>
          <property name="namedViews">
            <props>
              <prop key="failure">redirect:###!webroot###/top/password/input/</prop>
            </props>
          </property>
        </bean>

        <!-- 管理者権限チェック処理 -->
        <bean class="jp.co.transcosmos.dm3.servlet.URLCommandViewMapping">
          <property name="urlPattern">
            <list>
              <value>/top/admin/###allPages###/</value>
              <value>/top/admin/###allPages###/###allPages###/</value>
              <value>/top/###allPages###/csv/</value>
              <value>/top/###allPages###/delete/</value>
            </list>
          </property>
          <property name="defaultCommandName" value="adminRoleCheckFilter"/>
          <property name="filter" value="true"/>
          <property name="namedViews">
            <props>
              <prop key="failure">/WEB-INF/jsp/admin/error/Error_403.jsp</prop>
            </props>
          </property>
        </bean>

        <!-- メニュー情報をリクエストスコープへロード -->
        <bean class="jp.co.transcosmos.dm3.servlet.URLCommandViewMapping">
          <property name="urlPattern" ref="fullUrlPattern" />
          <property name="exceptionUrlPattern">
            <list>
              <value>/login/</value>
              <value>/login/check/</value>
              <value>/health_chk/</value>
            </list>
          </property>
          <property name="defaultCommandName" value="addMenuFilter"/>
          <property name="filter" value="true"/>
        </bean>

        <!-- CSRF チェックフィルター -->
        <bean class="jp.co.transcosmos.dm3.servlet.URLCommandViewMapping">
          <property name="urlPattern">
            <list>
              <value>/top/housing/###allPages###/result/</value>
              <value>/top/housing/reform/###allPages###/result/</value>
              <value>/top/housing/delete/</value>
              <value>/top/housing/detail/delete/</value>
              <value>/top/inquiry/###allPages###/result/</value>
              <value>/top/inquiry/delete/</value>
              <value>/top/mypage/###allPages###/result/</value>
              <value>/top/mypage/delConfirm/</value>
              <value>/top/information/###allPages###/result/</value>
              <value>/top/information/delConfirm/</value>
              <value>/top/admin/###allPages###/result/</value>
              <value>/top/admin/delete/</value>
              <value>/top/password/change/</value>
            </list>
          </property>
          <property name="defaultCommandName" value="tokenCheckFilter"/>
          <property name="filter" value="true"/>
        </bean>
      </list>
    </property>
  </bean>

</beans>
